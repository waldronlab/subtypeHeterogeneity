---
title: "Analyzing subclonality of expression subtypes"
author: Ludwig Geistlinger and Levi Waldron
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  % \VignetteIndexEntry{Functional enrichment analysis of high-throughput omics data}
  % \VignetteEngine{knitr::rmarkdown}
---

```{r style, echo = FALSE, results = 'asis'}
options(width=100)
knitr::opts_chunk$set(fig.align = "center")
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache=TRUE)
```

## Setup
```{r setup, echo=FALSE, results = 'asis'}
suppressPackageStartupMessages( library(subtypeHeterogeneity) )
```

## Cancer types
```{r ctypes}
RTCGAToolbox::getFirehoseDatasets()
```

## ABSOLUTE
```{r absolute}
absFile <- "extdata/ABSOLUTE_grangeslist.rds"
absFile <- system.file(absFile, package="subtypeHeterogeneity") 
absGRL <- readRDS(absFile) 
absGRL
```

## GISTIC2
```{r gistic}
gisticOV <- gistic2RSE(ctype="OV", peak="wide")
gisticOV
rowRanges(gisticOV)
assay(gisticOV)[1:5,1:5]
```

## Expression-based subtypes
```{r subtys}
ovsubs <- getBroadSubtypes(ctype="OV", clust.alg="CNMF")
dim(ovsubs)
head(ovsubs)
```

## Test: gistic-subtype association
```{r subtyAssoc}
adj.pvals <- testSubtypes(gisticOV, ovsubs, test.type="chisq", padj.method="BH")
length(adj.pvals)
head(adj.pvals)
sum(adj.pvals < 0.1)
```

## Subclonality

### Match subtyped samples and samples analyzed with ABSOLUTE
```{r matchCalls}
raOV <- getMatchedAbsoluteCalls(absGRL, ovsubs)
raOV
rowRanges(raOV)
```

### Summarize subclonality of ABSOLUTE calls falling on GISTIC regions 
```{r querySubcl}
subcl.gisticOV <- querySubclonality(raOV, query=rowRanges(gisticOV), sum.method="any")
dim(subcl.gisticOV)
subcl.gisticOV[1:5,1:5]
```

### Subclonality score: fraction of samples in which a mutation is subclonal
```{r subclScore}
subcl.score <- rowMeans(subcl.gisticOV)
summary(subcl.score)
```

## Correlation between subtype-association score and subclonality score
```{r cor}
assoc.score <- testSubtypes(gisticOV, ovsubs, test.type="perm")
cor(assoc.score, subcl.score, method="spearman")
wilcox.test(assoc.score, subcl.score)
permTest(gisticOV, ovsubs, subcl.score)
```

