---
title: "Subclonality of expression subtypes"
author: Ludwig Geistlinger and Levi Waldron
output:
  BiocStyle::html_document:
    toc: true
    toc_depth: 2
vignette: >
  % \VignetteIndexEntry{Functional enrichment analysis of high-throughput omics data}
  % \VignetteEngine{knitr::rmarkdown}
---

```{r style, echo = FALSE}
suppressPackageStartupMessages( library(subtypeHeterogeneity) )
```

# Setup
```{r setup}
library(subtypeHeterogeneity)
```

# Data sources

## Cancer types
```{r ctypes}
RTCGAToolbox::getFirehoseDatasets()
```

## ABSOLUTE
```{r absolute}
data.dir <- system.file("extdata", package="subtypeHeterogeneity") 
absFile <- file.path(data.dir, "ABSOLUTE_grangeslist.rds")
absGRL <- readRDS(absFile) 
absGRL
```

## GISTIC2
```{r gistic}
gisticOV <- gistic2RSE(ctype="OV", peak="wide")
gisticOV
rowRanges(gisticOV)
assay(gisticOV)[1:5,1:5]
```

## Expression-based subtypes
### Broad subtypes
```{r broadSubtys}
ovsubs <- getBroadSubtypes(ctype="OV", clust.alg="CNMF")
dim(ovsubs)
head(ovsubs)
table(ovsubs[,"cluster"])
```

### OV subtypes from different studies
```{r pooledSubtys}
pooled.file <- file.path(data.dir, "pooled_subtypes.rds")
pooled.subs <- readRDS(pooled.file)
table(pooled.subs[,"data.source"])
table(pooled.subs[,"Verhaak"])  
```

### TCGA subtype consistency
```{r subtyCons}
tab <- mapOVSubtypes(ovsubs, pooled.subs)
tab
sort( apply(tab, 1, which.max) )
```

### Subtype purity & ploidy
```{r subtyPP}
pp.file <- file.path(data.dir, "Purity_Ploidy.rds")
puri.ploi <- readRDS(pp.file)
head(puri.ploi)
```

```{r plotPP, fig.width=8, fig.height=8}
plotSubtypePurityPloidy(ovsubs, puri.ploi)
```

```{r stratPur}
sebin <- stratifyByPurity(ovsubs, puri.ploi, method="equal.bin")
lengths(sebin)
squint <- stratifyByPurity(ovsubs, puri.ploi, method="quintile")
lengths(squint)
```

```{r plotPurStrat, fig.width=5, fig.height=5}
plotPurityStrata(ovsubs, puri.ploi)
```

# Test: gistic-subtype association
```{r subtyAssoc}
pvals <- testSubtypes(gisticOV, ovsubs, padj.method="none")
adj.pvals <- p.adjust(pvals, method="BH")
length(adj.pvals)
head(adj.pvals)
sum(adj.pvals < 0.1)
```

```{r plotAssoc, fig.width=5, fig.height=5}
hist(pvals, breaks=25, col="firebrick",
        xlab="Subtype association p-value", main="")
```


# Subclonality

## Match subtyped samples and ABSOLUTE samples 
```{r matchCalls}
raOV <- getMatchedAbsoluteCalls(absGRL, ovsubs)
raOV
rowRanges(raOV)
```

## Summarize subclonality of ABSOLUTE calls in GISTIC regions 
```{r querySubcl}
subcl.gisticOV <- querySubclonality(raOV, query=rowRanges(gisticOV), sum.method="any")
dim(subcl.gisticOV)
subcl.gisticOV[1:5,1:5]
```

## Subclonality score
Def: Fraction of samples in which a mutation is subclonal.
```{r subclScore}
subcl.score <- rowMeans(subcl.gisticOV, na.rm=TRUE)
summary(subcl.score)
```

## Correlation: subtype-association score and subclonality score
```{r cor}
assoc.score <- testSubtypes(gisticOV, ovsubs, stat.only=TRUE)
cor(assoc.score, subcl.score, method="spearman")
cor.test(assoc.score, subcl.score, method="spearman", exact=FALSE)$p.value
corPermTest(gisticOV, ovsubs, subcl.score)
```

```{r plotCor, fig.width=6, fig.height=6}
par(pch=20)
plot(assoc.score, subcl.score, 
    xlab="subtype association score", ylab="subclonality score")
```

### Purity-stratified analysis
```{r purStrat}
sapply(squint, function(ids) analyzeStrata(ids, absGRL, gisticOV, ovsubs))
sapply(sebin[-1], function(ids) analyzeStrata(ids, absGRL, gisticOV, ovsubs))
```

### Only copy losses and single copy gains
```{r corNoHighAmp}
noHighAmp <- getMatchedAbsoluteCalls(absGRL, ovsubs, max.cn=3)
subcl.noHighAmp <- querySubclonality(noHighAmp, query=rowRanges(gisticOV))
subcl.noHighAmp <- rowMeans(subcl.noHighAmp, na.rm=TRUE)
cor(assoc.score, subcl.noHighAmp, method="spearman")
cor.test(assoc.score, subcl.noHighAmp, method="spearman", exact=FALSE)$p.value
corPermTest(gisticOV, ovsubs, subcl.noHighAmp)
```

```{r plotCorNHA, fig.width=6, fig.height=6}
par(pch=20)
plot(assoc.score, subcl.noHighAmp, 
    xlab="subtype association score", ylab="subclonality score")
```

# Other cancer types
```{r brca}
brca <- analyzeCancerType("BRCA", absGRL)
names(brca)
brca[1:2]
```

```{r gbm}
gbm <- analyzeCancerType("GBM", absGRL)
gbm[1:2]
```

```{r allCTypes}
allFile <- file.path(data.dir, "all_cancer_types.rds")
allCT <- readRDS(allFile)
```

```{r plotNrSamples, fig.width=12, fig.height=6}
st <- sapply(allCT, function(ct) nrow(ct$subtypes))
gs <- sapply(allCT, function(ct) ncol(ct$gistic))
as <- sapply(allCT, function(ct) sum(rownames(ct$subtypes) %in% names(absGRL)))

dat <- rbind(gs, st, as)
dat <- dat[,order(st)]
par(las=2)
barplot(dat, beside=TRUE, ylab="#samples")
legend("topleft", lwd=3, 
    legend=c("gistic", "subtype", "absolute"),  
    col=c("black", "darkgrey", "lightgrey"))
```

```{r descrStats, fig.width=6, fig.height=6}
nr.sts <- sapply(allCT, function(ct) length(unique(ct$subtypes[,1])))
nr.gregs <- sapply(allCT, function(ct) nrow(ct$gistic))
par(las=1)
plot(nr.sts, nr.gregs, col="white", xlab="#subtypes", ylab="#GISTIC.regions")
text(nr.sts, nr.gregs, names(nr.sts), cex=0.8)
```

```{r subclDistrs, fig.width=12, fig.height=6}
subcl.scores <- lapply(allCT, function(ct) ct$subcl.score)
meds <- sapply(subcl.scores, median)
ind <- order(meds)
subcl.scores <- subcl.scores[ind]
par(las=2)
boxplot(subcl.scores, ylab="subclonality score")
```

```{r corVolcano, fig.width=9, fig.height=6}
rho <- sapply(allCT, function(ct) ct$rho)
p <- sapply(allCT, function(ct) ct$p)
plot(rho, -log(p, base=10), ylab="-log10(p)", xlab="Spearman correlation", col="white")
text(rho, -log(p, base=10), names(allCT), cex=0.8)
```

